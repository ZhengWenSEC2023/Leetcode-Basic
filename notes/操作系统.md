# 操作系统
- 操作系统的演进
  - 无操作系统
    - 人工操作
    - 用户独占
    - CPU等待人工操作
    - 资源利用率很低
  - 批处理系统
    - 无需等待人工操作
    - 批量输入任务
    - 资源利用率提升
    - 多道程序设计
      - 早期批处理系统一次只能处理一个任务
      - 多道程序设计是的批处理可以一次处理多个任务
      - 指计算机内存中可以同时存放多个程序，互相不干扰
      - 多道程序在计算机的管理程序之下相互穿插运行
      - 对多道程序的管理是操作系统的重要功能
  - 分时系统
    - 人-机交互
    - 多用户共享
    - 及时调试程序
    - 资源利用率提升
- 操作系统的五大功能：
  - 进程管理
  - 存储管理
  - 作业管理
  - 文件管理
  - 设备管理
- 操作系统概览：
  - 定义：操作系统是管理计算机硬件和软件资源的计算机程序
  - 通过管理配置内存、决定资源供需顺序、控制输入输出设备等方式管理硬件资源
  - 提供让用户和系统交互的操作界面
  - **是管理硬件、提供用户交互的软件系统**
  - 操作系统的基本功能：
    - 操作系统**统一管理计算机资源**，如处理器、存储器、IO设备、文件等
    - 用户无需面向硬件接口编程，**实现对计算机资源的抽象**
    - **提供用户与计算机之间的接口**，分为系统调用、命令和图形窗口

    ![Alt text](img/OS_basic_func.png)

  - 操作系统的相关概念：
    - 并发性：
      - 并行是指两个或多个事件可以在**同一时刻**发生。多处理器一般强调并行。
      - 并发是指两个或多个事件可以在**同一时间间隔**发生，单处理器一般强调并发。
    - 共享性：
      - 操作系统中的资源可以提供给多个**并发**的程序共同使用。这种共同使用的形式称为资源共享，如多个程序可以同时使用主存资源
        - 互斥共享：当资源被程序A占用时，其他程序要想使用只能等待，只有A使用完以后，其他进程才可以使用该资源。强调某一时刻或较短的时间间隔
        - 同时访问：某种资源在一段时间内**并发地**被多个程序访问。这种“同时”是宏观的，从宏观去看，该资源可以被同时访问。强调一段时间内共享使用。
    - 虚拟性：把一个**物理实体**转变为若干个**逻辑实体**。物理实体是真实存在的，逻辑实体是虚拟的。虚拟技术主要有时分复用和空分复用
      - 时分复用：资源在时间上进行复用，不同程序**并发**使用
      - 多道程序分时使用计算机的硬件资源，提高资源的利用率
        - 虚拟处理器技术：借助多道程序设计技术，为每个程序建立进程，多个程序分时复用处理器
        - 虚拟设备技术：物理设备虚拟为多个逻辑设备，每个程序占用一个逻辑设备，多个程序通过逻辑设备**并发**访问
      - 空分复用技术：用来实现虚拟磁盘和虚拟内存等技术，提高资源利用率和编程效率
        - 虚拟磁盘技术：物理磁盘虚拟为逻辑磁盘。如C、D、E等逻辑盘
        - 虚拟内存技术：在逻辑上扩大程序的存储容量，可以使用比实际内存更大的容量
    - 异步性：在多道程序环境下，允许多个进程并发执行。进程在使用资源时可能需要等待或放弃。进程的执行并不是一气呵成的，而是以走走停停的形式推进
      - 进程以不可预知的速度向前推进，不知道程序何时执行、何时暂停、何时完成
- 进程管理：
  - 为什么需要进程：
    - 进程是系统进行资源分配和调度的基本单位
    - 进程作为程序独立运行的载体保障程序正常执行
    - 进程的存在是的操作系统资源的利用率大幅提升
  - 进程的实体：
    - 主存中的进程形态：由进程控制块（PCB, process control block）控制，是一块连续的地址空间，记录进程当前状态和控制进程运行的全部信息，使得进程是能够独立运行的基本单位。PCB是操作系统进行调度经常会被读取的信息，常驻于内存，存放在系统专门开辟的PCB区域内
      - 标识符：唯一标记一个进程，用于区别其他进程，进程ID
      - 状态：标记进程当前的状态，比如运行态
      - 程序计数器：指向进程即将被执行的下一条指令的地址
      - 内存指针：是程序代码、进程数据相关的指针
      - 上下文数据：存储进程执行时处理器存储的数据
      - IO状态信息：被进程IO操作占用的文件列表
      - 记账信息：使用处理器时间、时针数总和等
      - 分类：
        - 进程标识符（内部，外部）
        - 处理机状态（通用寄存器，指令计数器，PSW，用户的栈指针）
        - 进程调度信息（进程状态，进程的优先级，进程调度所需的其他信息、事件）
        - 进程控制信息（程序的数据地址，资源清单，进程同步和通信机制，链接指针）

      ![Alt text](img/OS_process_reality.png)

    - 进程与线程：
      - 进程 Process
        - 进程是操作系统进行资源分配和调度的**基本单位**
        - 一个进程可以有多个线程
        - 操作系统对进程的调度，实际上是对进程中线程的调度
      - 线程 Thread
        - 线程是操作系统进行运行调度的**最小单位**
        - 线程包含在进程之中，是进程中实际运行的工作单位，实际运行逻辑的是进程里的线程
        - 一个进程可以并发多个线程，每个线程执行不同的任务
        - 进程的线程共享进程的资源
        
        ![Alt text](img/OS_process_thread.png)

  - 五状态模型：
    - 就绪
      - 当进程被分配到除了CPU以外所有必要的资源后
      - 只要再获得CPU使用权，就可以立即运行
      - 其他资源都准备好（进程控制块，栈空间，堆空间，内存）、只差CPU资源的状态就为就绪状态
      - 操作系统中多个处于就绪状态的进程通常排成一个队列，称为就绪队列
    - 阻塞
      - 进程因某种原因（如其他设备未就而无法继续执行）从而放弃CPU的状态称为阻塞状态。
      - 操作系统中处于多个阻塞状态的进程组成阻塞队列
    - 执行
      - 进程获得CPU，其程序正在执行，称为就绪状态
      - 在单处理机中，在某个时刻只能有一个进程是处于执行状态
    - 就绪状态由**进程调度**获得CPU资源，切换到执行状态。执行状态**时间片用完**，切换为就绪状态。执行状态由IO请求切换到阻塞状态，阻塞状态因为IO完成，切换到就绪状态
    
    ![Alt text](img/OS_process_switch.png)

    - 创建
      - 分配PCB -> 插入就绪队列
      - 创建进程时**拥有PCB**但**未拥有其他资源尚未就绪**的状态称为创建状态，通过fork函数创建进程
    - 终止
      - 系统清理 -> 归还PCB
      - 进程结束由系统清理或归还PCB的状态称为终止状态
  - 进程同步
    - 生产者消费者问题，由于多进程并发执行，对缓冲区操作不同步，导致数据异常。缓冲区数据称为临界资源
    
    ![Alt text](img/OS_buy_produce.png)
    
    - 哲学家进餐问题，由于多进程，发生死锁
    - 问题根源是没有进程间的通信，**对竞争资源在多进程间进行使用次序的协调，使得并发执行的多个进程之间可以有效使用资源和相互合作**
    - 临界资源：一些虽然作为共享资源却又无法同时被多个线程共同访问的共享资源。当有进程在使用临界资源时，其他进程必须依据操作系统的同步机制等待占用进程释放该共享资源才可以重新竞争，使用共享资源

    - 同步原则：
      - 空闲让进：资源无占用，允许使用
      - 忙则等待：资源有占用，请求进程等待
      - 有限等待：保证有限等待时间能够使用资源
      - 让权等待：等待时，进程需要让出CPU（阻塞状态）
  - 线程同步：
    - 进程内多线程也需要同步，原理同进程同步，只不过线程共享内存，进程需要通信
- Linux进程管理：
  - 进程类型：
    - 前台进程
      - 具有终端，可以与用户交互的进程。执行时占用shell，其他输入命令无效
    - 后台进程
      - 没有占用终端。优先级比前台进程低。将需要执行的命令以 & 结束
      ```shell

      ```
    - 守护进程
      - 特殊的后台进程，在系统引导时启动，一直运行到系统关闭
  - 进程ID
    - 进程ID是进程的唯一标记，每个进程拥有不同的ID（PCB中的数据）
    - 进程ID是一个非负整数，最大值由操作系统限定
    - 进程层级关系：父进程调用fork()函数，创建子进程。层级关系可以通过**pstree**命令查看
    - ID为0的进程为idle进程，是系统创建的第一个进程
    - ID为1的进程是init进程，是0号进程的子进程，完成系统初始化。
    - Init进程是所有用户进程的祖先进程
  - 进程的标记
    - R: 运行状态
    - S: 睡眠状态
    - D: 进程正处于IO等待的睡眠状态
    - T: 进程正处于暂停状态
    - Z: 进程正处于退出状态，或僵尸进程
  - 操作Linux进程的相关命令：
    - ps: 列出当前进程
      - -aux: 打印进程相关信息，用户，id，运行时间
      - -u 用户名：查看相关用户的进程
      - -aux | grep 'python3'
    - top: 查看当前进程全部信息
    - kill: 发送指定信号给进程